name: "CI"

on: ["push", "pull_request"]

env:
  GO_VERSION: '1.24.2'

jobs:
  ci:
    strategy:
      matrix:
        include:
          - goos: linux
            goarch: amd64
            runs_on: ubuntu-latest
          - goos: linux
            goarch: arm64
            runs_on: ubuntu-24.04-arm
          - goos: darwin
            goarch: amd64
            runs_on: macos-15-large
          - goos: darwin
            goarch: arm64
            runs_on: macos-15
    runs-on: ${{ matrix.runs_on }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Install development dependencies
        if: ${{ matrix.goos == 'linux' }}
        run: sudo apt install -y libasound2-dev

      - name: Test
        run: go test ./src/...

      - name: Static Analysis
        uses: dominikh/staticcheck-action@v1
        with:
          version: "2025.1.1"
          install-go: false
          cache-key: ${{ matrix.goos }}${{ matrix.goarch }}${{ env.GO_VERSION }}

      - name: Build
        run: |
          mkdir -p dist
          EXT=""
          if [ "${{ matrix.goos }}" = "windows" ]; then EXT=".exe"; fi
          if [ "${{ matrix.goos }}" = "linux" ]; then
            CGO_ENABLED=1 GOOS=${{ matrix.goos }} GOARCH=${{ matrix.goarch }} go build -o dist/chrono-ntp ./src/...
          else
            GOOS=${{ matrix.goos }} GOARCH=${{ matrix.goarch }} go build -o dist/chrono-ntp$EXT ./src/...
          fi
